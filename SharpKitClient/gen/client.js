/* Generated by SharpKit 5 v5.4.4 */
if (typeof($CreateDelegate)=='undefined'){
    if(typeof($iKey)=='undefined') var $iKey = 0;
    if(typeof($pKey)=='undefined') var $pKey = String.fromCharCode(1);
    var $CreateDelegate = function(target, func){
        if (target == null || func == null) 
            return func;
        if(func.target==target && func.func==func)
            return func;
        if (target.$delegateCache == null)
            target.$delegateCache = {};
        if (func.$key == null)
            func.$key = $pKey + String(++$iKey);
        var delegate;
        if(target.$delegateCache!=null)
            delegate = target.$delegateCache[func.$key];
        if (delegate == null){
            delegate = function(){
                return func.apply(target, arguments);
            };
            delegate.func = func;
            delegate.target = target;
            delegate.isDelegate = true;
            if(target.$delegateCache!=null)
                target.$delegateCache[func.$key] = delegate;
        }
        return delegate;
    }
}


var $mvcHlp = function (){
};
$mvcHlp.prototype.Connect = function (data){
    SharpKitClient.Client.inst.onConnected(data);
};
$mvcHlp.prototype.Disconnect = function (data){
    SharpKitClient.Client.inst.onDisconected(data);
};
$mvcHlp.prototype.StartGame = function (data){
    SharpKitClient.Client.inst.onStartGame(data);
};
$mvcHlp.prototype.ResetGame = function (data){
    SharpKitClient.Client.inst.onResetGame(data);
};
$mvcHlp.prototype.Turn = function (data){
    SharpKitClient.Client.inst.onTurn(data);
};
if (typeof(SharpKitClient) == "undefined")
    var SharpKitClient = {};
SharpKitClient.Client = function (){
    this._clientId = null;
    this._div = null;
    this._figure = SharpKitLib.EState.empty;
    this._table = null;
    this._tableCnt = null;
    this._turn = null;
    this._turnClientId = null;
    this._welcomeDiv = null;
    this.ClientId = null;
};
SharpKitClient.Client.inst = new SharpKitClient.Client();
SharpKitClient.Client.prototype.init = function (){
    this._div = document.createElement('div');
    document.body.appendChild(this._div);
    this._welcomeDiv = document.createElement('div');
    this._div.appendChild(this._welcomeDiv);
    $server.connect();
    window.addEventListener("unload", $CreateDelegate(this, this.OnBeforeUnload));
};
SharpKitClient.Client.prototype.onConnected = function (data){
    this.ClientId = data.ClientId;
    this._welcomeDiv.innerHTML = "Connected.";
    var startGameData = new SharpKitLib.entity.StartGameData(this.ClientId);
    startGameData.ClientId = this.ClientId;
    $server.send(startGameData);
};
SharpKitClient.Client.prototype.onDisconected = function (disconnectData){
    this._welcomeDiv.innerHTML = "Disconected.";
};
SharpKitClient.Client.prototype.onStartGame = function (data){
    this._turnClientId = "";
    this._figure = SharpKitLib.EState.empty;
    this._welcomeDiv.innerHTML = "";
    if (this._welcomeDiv.parentNode != null){
        this._welcomeDiv.parentNode.removeChild(this._welcomeDiv);
    }
    if (null != this._tableCnt && this._tableCnt.parentNode != null){
        this._tableCnt.parentNode.removeChild(this._tableCnt);
    }
    if (null != this._turn && this._turn.parentNode != null){
        this._turn.parentNode.removeChild(this._turn);
    }
    this._turn = document.createElement('div');
    js.addClass(this._turn, "turn");
    this._div.appendChild(this._turn);
    this._tableCnt = document.createElement('span');
    js.addClass(this._tableCnt, "tableCnt");
    this._table = document.createElement('table');
    this._tableCnt.appendChild(this._table);
    js.attach(this._table, "click", $CreateDelegate(this, this.onTableClick));
    js.attach(this._table, "touchstart", $CreateDelegate(this, this.onTableClick));
    js.addClass(this._table, "table");
    for (var y = 0; y < 3; ++y){
        var row = document.createElement('tr');
        this._table.appendChild(row);
        row.setAttribute("rowIdx", y.toString());
        for (var x = 0; x < 3; ++x){
            var cell = document.createElement('td');
            row.appendChild(cell);
            js.addClass(cell, "tableCell");
        }
    }
    this._div.appendChild(this._tableCnt);
    this._figure = (data.FirstClientId == this.ClientId) ? SharpKitLib.EState.blue : SharpKitLib.EState.red;
    this._turnClientId = data.FirstClientId;
    this.RefreshTurn();
};
SharpKitClient.Client.prototype.onTurn = function (turnData){
    var message = turnData.message;
    if (turnData.message == ""){
        this.renderFigure(turnData);
        this._turnClientId = turnData.nextClientId;
        this.RefreshTurn();
    }
    else if (turnData.message == "turn again"){
    }
    else if (message.indexOf("winn") == 0){
        js.addClass(this._table, turnData.message);
        this.renderFigure(turnData);
        if (turnData.ClientId == this.ClientId){
            window.alert("You winn");
        }
        else {
            window.alert("You loss");
        }
        var resetGameData = new SharpKitLib.entity.ResetGameData(this.ClientId);
        resetGameData.GameId = turnData.GameId;
        $server.send(resetGameData);
    }
    else if (turnData.message == "equal"){
        this.renderFigure(turnData);
        window.alert("equal");
    }
};
SharpKitClient.Client.prototype.onResetGame = function (resetGameData){
    console.log("reset game");
    var data = new SharpKitLib.entity.StartGameData(this.ClientId);
    data.GameId = resetGameData.GameId;
    $server.send(data);
};
SharpKitClient.Client.prototype.renderFigure = function (data){
    var row = this._table.rows[data.y];
    var cell = row.cells[data.x];
    if ((data.figure == SharpKitLib.EState.blue)){
        js.addClass(cell, "tableCellX");
    }
    else {
        js.addClass(cell, "tableCell0");
    }
};
SharpKitClient.Client.prototype.ensureClientId = function (){
    var url = window.document.location.href;
    var idx = url.lastIndexOf("?") + 1;
    if (idx > 0){
        var name = url.substring(idx);
        var arr = name.split("=");
        this._clientId = arr[1].toString();
    }
    else if (localStorage.getItem("clientId") != null){
        this._clientId = localStorage.getItem("clientId");
    }
    else {
        this._clientId = js.createGuid();
    }
    localStorage.setItem("clientId", this._clientId);
};
SharpKitClient.Client.prototype.RefreshTurn = function (){
    if (this._turnClientId == this.ClientId){
        js.removeClass(this._turn, "notMyTurn");
        js.addClass(this._turn, "myTurn");
    }
    else {
        js.removeClass(this._turn, "myTurn");
        js.addClass(this._turn, "notMyTurn");
    }
};
SharpKitClient.Client.prototype.onTableClick = function (evt){
    if (this._turnClientId == this.ClientId){
        var el = evt.target;
        if (el instanceof HTMLTableCellElement){
            var cell = el;
            var row = cell.parentNode;
            var data = new SharpKitLib.entity.TurnData(this.ClientId);
            data.x = cell.cellIndex;
            data.y = parseInt(row.getAttribute("rowIdx"), 10);
            data.figure = this._figure;
            $server.send(data);
        }
    }
};
SharpKitClient.Client.prototype.OnBeforeUnload = function (evt){
    $server.disconnect();
};

